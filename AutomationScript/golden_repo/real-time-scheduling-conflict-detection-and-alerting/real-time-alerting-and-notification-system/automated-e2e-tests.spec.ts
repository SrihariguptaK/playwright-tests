json
{
  "success": true,
  "playwrightTests": [
    {
      "storyId": "story-20",
      "storyTitle": "As Scheduler, I want the system to track alert delivery status and retry failed notifications to ensure reliable communication",
      "testFile": "alert-delivery-tracking.spec.ts",
      "testCode": "import { test, expect } from '@playwright/test';\n\ntest.describe('Alert Delivery Status Tracking and Retry Mechanism', () => {\n  const BASE_URL = process.env.BASE_URL || 'http://localhost:3000';\n  const API_URL = process.env.API_URL || 'http://localhost:3000/api';\n\n  test.beforeEach(async ({ page }) => {\n    await page.goto(`${BASE_URL}/admin/delivery-dashboard`);\n  });\n\n  test('Verify delivery status tracking and retry mechanism (happy-path)', async ({ page, request }) => {\n    // Configure test environment to simulate delivery failures for specific channels\n    await page.goto(`${BASE_URL}/admin/test-configuration`);\n    await page.getByTestId('simulate-failures-toggle').check();\n    await page.getByTestId('failure-channel-email').check();\n    await page.getByTestId('failure-channel-sms').check();\n    await page.getByTestId('save-test-config').click();\n    await expect(page.getByText('Test configuration saved')).toBeVisible();\n\n    // Trigger conflict detection to generate alerts across multiple channels\n    await page.goto(`${BASE_URL}/scheduler/conflicts`);\n    await page.getByTestId('trigger-conflict-detection').click();\n    await expect(page.getByText('Conflict detection initiated')).toBeVisible();\n    await page.waitForTimeout(2000);\n\n    // Monitor initial delivery attempts for all channels\n    const deliveryResponse = await request.get(`${API_URL}/alert-delivery-status`);\n    expect(deliveryResponse.ok()).toBeTruthy();\n    const deliveryData = await deliveryResponse.json();\n    \n    // Verify failure details are recorded accurately in logs\n    const failedDeliveries = deliveryData.deliveries.filter((d: any) => d.status === 'failed');\n    expect(failedDeliveries.length).toBeGreaterThan(0);\n    expect(failedDeliveries.some((d: any) => d.channel === 'email')).toBeTruthy();\n    expect(failedDeliveries.some((d: any) => d.channel === 'sms')).toBeTruthy();\n    \n    failedDeliveries.forEach((delivery: any) => {\n      expect(delivery).toHaveProperty('alertId');\n      expect(delivery).toHaveProperty('channel');\n      expect(delivery).toHaveProperty('status');\n      expect(delivery).toHaveProperty('failureReason');\n      expect(delivery).toHaveProperty('attemptTimestamp');\n    });\n\n    // Remove delivery failure simulation to allow successful retries\n    await page.goto(`${BASE_URL}/admin/test-configuration`);\n    await page.getByTestId('simulate-failures-toggle').uncheck();\n    await page.getByTestId('save-test-config').click();\n    await expect(page.getByText('Test configuration saved')).toBeVisible();\n\n    // Wait for automatic retry according to configured retry policy\n    await page.waitForTimeout(5000);\n\n    // Verify alerts are delivered successfully on retry\n    const retryResponse = await request.get(`${API_URL}/alert-delivery-status`);\n    expect(retryResponse.ok()).toBeTruthy();\n    const retryData = await retryResponse.json();\n    \n    const successfulRetries = retryData.deliveries.filter((d: any) => \n      d.status === 'delivered' && d.attemptNumber > 1\n    );\n    expect(successfulRetries.length).toBeGreaterThan(0);\n\n    // Navigate to delivery status dashboard\n    await page.goto(`${BASE_URL}/admin/delivery-dashboard`);\n    await expect(page.getByTestId('delivery-dashboard-title')).toBeVisible();\n\n    // Locate the specific alert in the dashboard\n    const firstAlertId = failedDeliveries[0].alertId;\n    await page.getByTestId('search-alert-input').fill(firstAlertId);\n    await page.getByTestId('search-alert-button').click();\n    \n    const alertRow = page.getByTestId(`alert-row-${firstAlertId}`);\n    await expect(alertRow).toBeVisible();\n\n    // Verify accuracy of status and retry attempts displayed\n    await alertRow.click();\n    await expect(page.getByTestId('alert-detail-panel')).toBeVisible();\n    await expect(page.getByTestId('delivery-status')).toContainText('delivered');\n    await expect(page.getByTestId('retry-count')).toContainText('2');\n    await expect(page.getByTestId('initial-attempt-status')).toContainText('failed');\n    await expect(page.getByTestId('retry-attempt-status')).toContainText('delivered');\n\n    // Check dashboard filters and sorting options\n    await page.getByTestId('filter-dropdown').click();\n    await expect(page.getByTestId('filter-by-status')).toBeVisible();\n    await expect(page.getByTestId('filter-by-channel')).toBeVisible();\n    await expect(page.getByTestId('filter-by-date')).toBeVisible();\n    \n    await page.getByTestId('sort-dropdown').click();\n    await expect(page.getByTestId('sort-by-timestamp')).toBeVisible();\n    await expect(page.getByTestId('sort-by-status')).toBeVisible();\n    await expect(page.getByTestId('sort-by-retry-count')).toBeVisible();\n  });\n\n  test('Test administrator notifications on persistent failures (error-case)', async ({ page, request }) => {\n    // Configure test environment to simulate persistent SMS delivery failures\n    await page.goto(`${BASE_URL}/admin/test-configuration`);\n    await page.getByTestId('simulate-failures-toggle').check();\n    await page.getByTestId('failure-channel-sms').check();\n    await page.getByTestId('persistent-failure-toggle').check();\n    await page.getByTestId('max-retry-attempts').fill('3');\n    await page.getByTestId('save-test-config').click();\n    await expect(page.getByText('Test configuration saved')).toBeVisible();\n\n    // Trigger conflict detection to generate an alert for a scheduler user\n    await page.goto(`${BASE_URL}/scheduler/conflicts`);\n    await page.getByTestId('trigger-conflict-detection').click();\n    await expect(page.getByText('Conflict detection initiated')).toBeVisible();\n    await page.waitForTimeout(2000);\n\n    // Monitor initial SMS delivery attempt\n    let deliveryResponse = await request.get(`${API_URL}/alert-delivery-status?channel=sms`);\n    expect(deliveryResponse.ok()).toBeTruthy();\n    let deliveryData = await deliveryResponse.json();\n    \n    const initialAttempt = deliveryData.deliveries.find((d: any) => d.attemptNumber === 1);\n    expect(initialAttempt).toBeDefined();\n    expect(initialAttempt.status).toBe('failed');\n    expect(initialAttempt.channel).toBe('sms');\n\n    // Wait for first automatic retry attempt\n    await page.waitForTimeout(3000);\n    deliveryResponse = await request.get(`${API_URL}/alert-delivery-status?channel=sms`);\n    deliveryData = await deliveryResponse.json();\n    const firstRetry = deliveryData.deliveries.find((d: any) => d.attemptNumber === 2);\n    expect(firstRetry).toBeDefined();\n    expect(firstRetry.status).toBe('failed');\n\n    // Wait for second automatic retry attempt\n    await page.waitForTimeout(3000);\n    deliveryResponse = await request.get(`${API_URL}/alert-delivery-status?channel=sms`);\n    deliveryData = await deliveryResponse.json();\n    const secondRetry = deliveryData.deliveries.find((d: any) => d.attemptNumber === 3);\n    expect(secondRetry).toBeDefined();\n    expect(secondRetry.status).toBe('failed');\n\n    // Wait for third automatic retry attempt (final retry per policy)\n    await page.waitForTimeout(3000);\n    deliveryResponse = await request.get(`${API_URL}/alert-delivery-status?channel=sms`);\n    deliveryData = await deliveryResponse.json();\n    const thirdRetry = deliveryData.deliveries.find((d: any) => d.attemptNumber === 4);\n    expect(thirdRetry).toBeDefined();\n    expect(thirdRetry.status).toBe('failed');\n\n    // Verify system flags the alert as persistently failed\n    const persistentFailure = deliveryData.deliveries.find((d: any) => d.persistentFailure === true);\n    expect(persistentFailure).toBeDefined();\n    expect(persistentFailure.status).toBe('failed');\n    expect(persistentFailure.attemptNumber).toBeGreaterThanOrEqual(4);\n\n    // Check if administrator notification is triggered\n    const adminNotificationResponse = await request.get(`${API_URL}/admin/notifications`);\n    expect(adminNotificationResponse.ok()).toBeTruthy();\n    const adminNotifications = await adminNotificationResponse.json();\n    const failureNotification = adminNotifications.notifications.find((n: any) => \n      n.type === 'persistent_delivery_failure'\n    );\n    expect(failureNotification).toBeDefined();\n\n    // Access administrator email inbox\n    await page.goto(`${BASE_URL}/admin/email-inbox`);\n    await expect(page.getByTestId('email-inbox-title')).toBeVisible();\n    \n    const failureEmail = page.getByTestId('email-persistent-failure').first();\n    await expect(failureEmail).toBeVisible();\n    await failureEmail.click();\n\n    // Check administrator in-app notification center\n    await page.goto(`${BASE_URL}/admin/notifications`);\n    await expect(page.getByTestId('notification-center-title')).toBeVisible();\n    \n    const inAppNotification = page.getByTestId('notification-persistent-failure').first();\n    await expect(inAppNotification).toBeVisible();\n    await inAppNotification.click();\n\n    // Verify notification content includes all necessary details\n    await expect(page.getByTestId('notification-detail-panel')).toBeVisible();\n    await expect(page.getByTestId('notification-alert-id')).toBeVisible();\n    await expect(page.getByTestId('notification-channel')).toContainText('sms');\n    await expect(page.getByTestId('notification-failure-count')).toContainText('4');\n    await expect(page.getByTestId('notification-scheduler-info')).toBeVisible();\n    await expect(page.getByTestId('notification-failure-reason')).toBeVisible();\n    await expect(page.getByTestId('notification-timestamp')).toBeVisible();\n\n    // Access delivery status dashboard as administrator\n    await page.goto(`${BASE_URL}/admin/delivery-dashboard`);\n    await expect(page.getByTestId('delivery-dashboard-title')).toBeVisible();\n\n    // Verify persistent failure is logged comprehensively\n    await page.getByTestId('filter-dropdown').click();\n    await page.getByTestId('filter-by-status').click();\n    await page.getByRole('option', { name: 'Persistent Failure' }).click();\n    \n    const persistentFailureRow = page.getByTestId('persistent-failure-row').first();\n    await expect(persistentFailureRow).toBeVisible();\n    await persistentFailureRow.click();\n    \n    await expect(page.getByTestId('alert-detail-panel')).toBeVisible();\n    await expect(page.getByTestId('delivery-status')).toContainText('persistent failure');\n    await expect(page.getByTestId('total-attempts')).toContainText('4');\n    await expect(page.getByTestId('channel-info')).toContainText('sms');\n    await expect(page.getByTestId('failure-timeline')).toBeVisible();\n    \n    const attemptLogs = page.getByTestId('attempt-log-entry');\n    await expect(attemptLogs).toHaveCount(4);\n    \n    for (let i = 0; i < 4; i++) {\n      const logEntry = attemptLogs.nth(i);\n      await expect(logEntry).toContainText('failed');\n      await expect(logEntry).toContainText(`Attempt ${i + 1}`);\n    }\n  });\n});"
    }
  ]
}